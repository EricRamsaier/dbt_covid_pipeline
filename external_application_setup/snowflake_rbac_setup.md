**Snowflake RBAC & Schema Setup**

This document outlines a one-time bootstrap and ongoing runtime grants for a Snowflake + dbt project with 4 databases and 5 roles. Follow each section in order.

---

## 1. Bootstrapping: Databases, Schemas & Roles

```sql
-- 1.1 Create Databases
CREATE DATABASE IF NOT EXISTS RAW;
CREATE DATABASE IF NOT EXISTS DWH;
CREATE DATABASE IF NOT EXISTS REPORTING;
CREATE DATABASE IF NOT EXISTS LANDING_EXT;

-- 1.2 Create Roles
CREATE ROLE IF NOT EXISTS RAW_INGEST_SVC_ROLE;
CREATE ROLE IF NOT EXISTS TRANSFORM_SVC_ROLE;
CREATE ROLE IF NOT EXISTS REPORTING_SVC_ROLE;
CREATE ROLE IF NOT EXISTS DEVELOPER_ROLE;
CREATE ROLE IF NOT EXISTS ANALYST_ROLE;

-- 1.3 Create Users & Attach Roles
CREATE USER IF NOT EXISTS raw_ingest_svc_user
  PASSWORD = '<REDACTED>'
  DEFAULT_ROLE = RAW_INGEST_SVC_ROLE
  DEFAULT_WAREHOUSE = COMPUTE_WH
  MUST_CHANGE_PASSWORD = FALSE;
GRANT ROLE RAW_INGEST_SVC_ROLE  TO USER raw_ingest_svc_user;

CREATE USER IF NOT EXISTS transform_svc_user
  PASSWORD = '<REDACTED>'
  DEFAULT_ROLE = TRANSFORM_SVC_ROLE
  DEFAULT_WAREHOUSE = COMPUTE_WH
  MUST_CHANGE_PASSWORD = FALSE;
GRANT ROLE TRANSFORM_SVC_ROLE   TO USER transform_svc_user;

CREATE USER IF NOT EXISTS reporting_svc_user
  PASSWORD = '<REDACTED>'
  DEFAULT_ROLE = REPORTING_SVC_ROLE
  DEFAULT_WAREHOUSE = COMPUTE_WH
  MUST_CHANGE_PASSWORD = FALSE;
GRANT ROLE REPORTING_SVC_ROLE   TO USER reporting_svc_user;
```

### 1.4 Ownership Transfers (retain existing grants)

```sql
USE ROLE SECURITYADMIN;

GRANT OWNERSHIP ON SCHEMA LANDING_EXT.S3        TO ROLE RAW_INGEST_SVC_ROLE  COPY CURRENT GRANTS;
GRANT OWNERSHIP ON SCHEMA DWH.STG               TO ROLE TRANSFORM_SVC_ROLE   COPY CURRENT GRANTS;
GRANT OWNERSHIP ON SCHEMA DWH.INT               TO ROLE TRANSFORM_SVC_ROLE   COPY CURRENT GRANTS;
GRANT OWNERSHIP ON SCHEMA DWH.SNAPSHOTS         TO ROLE TRANSFORM_SVC_ROLE   COPY CURRENT GRANTS;
GRANT OWNERSHIP ON SCHEMA DWH.AUDIT             TO ROLE TRANSFORM_SVC_ROLE   COPY CURRENT GRANTS;
GRANT OWNERSHIP ON SCHEMA REPORTING.MARTS       TO ROLE TRANSFORM_SVC_ROLE   COPY CURRENT GRANTS;
```

---

## 2. Runtime Grants: Existing & Future Objects

```sql
USE ROLE SECURITYADMIN;

-- 2.1 DB-level privileges
GRANT USAGE            ON DATABASE RAW       TO ROLE TRANSFORM_SVC_ROLE;
GRANT USAGE            ON DATABASE DWH       TO ROLE TRANSFORM_SVC_ROLE;
GRANT USAGE            ON DATABASE REPORTING TO ROLE TRANSFORM_SVC_ROLE;
GRANT USAGE            ON DATABASE LANDING_EXT TO ROLE RAW_INGEST_SVC_ROLE;

-- 2.2 Schema-level privileges (existing)
GRANT USAGE, CREATE TABLE, CREATE VIEW
  ON ALL SCHEMAS IN DATABASE DWH
  TO ROLE TRANSFORM_SVC_ROLE;

GRANT USAGE, CREATE SCHEMA, CREATE STAGE, CREATE FILE FORMAT
  ON DATABASE LANDING_EXT
  TO ROLE RAW_INGEST_SVC_ROLE;

GRANT USAGE, CREATE TABLE, CREATE VIEW
  ON SCHEMA REPORTING.MARTS
  TO ROLE TRANSFORM_SVC_ROLE;

-- 2.3 DML & SELECT (existing)
GRANT SELECT ON ALL TABLES IN SCHEMA RAW             TO ROLE TRANSFORM_SVC_ROLE;
GRANT SELECT ON ALL TABLES IN SCHEMA DWH.AUDIT       TO ROLE TRANSFORM_SVC_ROLE;
GRANT SELECT ON ALL TABLES IN SCHEMA DWH.INT         TO ROLE TRANSFORM_SVC_ROLE;
GRANT SELECT ON ALL TABLES IN SCHEMA DWH.SNAPSHOTS   TO ROLE TRANSFORM_SVC_ROLE;
GRANT SELECT ON ALL TABLES IN SCHEMA DWH.STG         TO ROLE TRANSFORM_SVC_ROLE;

GRANT SELECT ON ALL TABLES IN SCHEMA REPORTING.MARTS TO ROLE TRANSFORM_SVC_ROLE;

-- 2.4 Future grants
GRANT CREATE SCHEMA, USAGE
  ON DATABASE DWH
  TO ROLE TRANSFORM_SVC_ROLE;

GRANT USAGE
  ON FUTURE SCHEMAS IN DATABASE DWH
  TO ROLE TRANSFORM_SVC_ROLE;

GRANT SELECT ON FUTURE TABLES IN SCHEMA DWH.AUDIT       TO ROLE TRANSFORM_SVC_ROLE;
GRANT SELECT ON FUTURE TABLES IN SCHEMA DWH.INT         TO ROLE TRANSFORM_SVC_ROLE;
GRANT SELECT ON FUTURE TABLES IN SCHEMA DWH.SNAPSHOTS   TO ROLE TRANSFORM_SVC_ROLE;
GRANT SELECT ON FUTURE TABLES IN SCHEMA DWH.STG         TO ROLE TRANSFORM_SVC_ROLE;

GRANT SELECT ON FUTURE TABLES IN SCHEMA REPORTING.MARTS TO ROLE TRANSFORM_SVC_ROLE;
```

---

## 3. Helper: Audit Log Table

```sql
CREATE OR REPLACE TABLE IF NOT EXISTS DWH.AUDIT.MODEL_RUN_LOG (
  model_name        TEXT,
  run_ts            TIMESTAMP_TZ,
  dbt_invocation_id TEXT,
  row_count         INTEGER,
  database_name     TEXT,
  schema_name       TEXT,
  table_name        TEXT
);

GRANT OWNERSHIP
  ON TABLE DWH.AUDIT.MODEL_RUN_LOG
  TO ROLE TRANSFORM_SVC_ROLE
  COPY CURRENT GRANTS;
```

---

## 4. Read-only Roles

```sql
USE ROLE SECURITYADMIN;

-- Developer: full read across RAW, DWH, REPORTING
GRANT USAGE ON DATABASE RAW                   TO ROLE DEVELOPER_ROLE;
GRANT USAGE ON ALL SCHEMAS IN DATABASE RAW    TO ROLE DEVELOPER_ROLE;
GRANT SELECT ON ALL TABLES IN DATABASE RAW   TO ROLE DEVELOPER_ROLE;
GRANT SELECT ON FUTURE TABLES IN DATABASE RAW TO ROLE DEVELOPER_ROLE;

GRANT USAGE ON DATABASE DWH                   TO ROLE DEVELOPER_ROLE;
GRANT USAGE ON ALL SCHEMAS IN DATABASE DWH    TO ROLE DEVELOPER_ROLE;
GRANT SELECT ON ALL TABLES IN DATABASE DWH    TO ROLE DEVELOPER_ROLE;
GRANT SELECT ON FUTURE TABLES IN DATABASE DWH TO ROLE DEVELOPER_ROLE;

GRANT USAGE ON DATABASE REPORTING             TO ROLE DEVELOPER_ROLE;
GRANT USAGE ON SCHEMA REPORTING.MARTS         TO ROLE DEVELOPER_ROLE;
GRANT SELECT ON ALL TABLES IN SCHEMA REPORTING.MARTS TO ROLE DEVELOPER_ROLE;
GRANT SELECT ON FUTURE TABLES IN SCHEMA REPORTING.MARTS TO ROLE DEVELOPER_ROLE;

-- Analyst: read-only on final marts
GRANT USAGE ON SCHEMA REPORTING.MARTS         TO ROLE ANALYST_ROLE;
GRANT SELECT ON ALL TABLES IN SCHEMA REPORTING.MARTS TO ROLE ANALYST_ROLE;
GRANT SELECT ON FUTURE TABLES IN SCHEMA REPORTING.MARTS TO ROLE ANALYST_ROLE;

-- Reporting Service (e.g. BI): same as analyst
GRANT USAGE ON SCHEMA REPORTING.MARTS         TO ROLE REPORTING_SVC_ROLE;
GRANT SELECT ON ALL TABLES IN SCHEMA REPORTING.MARTS TO ROLE REPORTING_SVC_ROLE;
GRANT SELECT ON FUTURE TABLES IN SCHEMA REPORTING.MARTS TO ROLE REPORTING_SVC_ROLE;
```

---

## 5. Monitoring & Operations

```sql
-- Monitor queries & warehouses
GRANT MONITOR ON ACCOUNT TO ROLE TRANSFORM_SVC_ROLE;
GRANT MONITOR ON ACCOUNT TO ROLE DEVELOPER_ROLE;
GRANT MONITOR ON ACCOUNT TO ROLE REPORTING_SVC_ROLE;

-- Tasks & Streams
GRANT OPERATE ON ALL TASKS IN SCHEMA DWH.INT    TO ROLE TRANSFORM_SVC_ROLE;
GRANT OPERATE ON FUTURE TASKS IN SCHEMA DWH.INT TO ROLE TRANSFORM_SVC_ROLE;

GRANT CREATE STREAM, USAGE ON SCHEMA DWH.STG   TO ROLE TRANSFORM_SVC_ROLE;
GRANT SELECT ON ALL STREAMS IN SCHEMA DWH.STG  TO ROLE TRANSFORM_SVC_ROLE;
GRANT SELECT ON FUTURE STREAMS IN SCHEMA DWH.STG TO ROLE TRANSFORM_SVC_ROLE;
```

---

*This script provides a reference implementation of an RBAC-first Snowflake setup for dbt pipelines.*
